<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Image Compressor with Crop</title>
<style>
 body { font-family: Arial; max-width:640px; margin:30px auto; }
 .box { position:relative; width:500px; height:350px; border:1px solid #444; }
 canvas { width:100%; height:100%; cursor:crosshair; }
 #download {
   position:absolute; top:8px; right:8px;
   background:#007bff; color:#fff;
   padding:6px 10px; text-decoration:none;
   display:none; font-size:14px;
 }
 label { display:block; margin-top:12px; }
</style>
</head>
<body>

<h3>Image Resizer & Compressor</h3>

<input type="file" id="upload" accept="image/*">

<label>
 Width (px):
 <input type="number" id="width" value="800">
</label>

<label>
 Compression: <span id="qval">80</span>%
 <input type="range" id="quality" min="10" max="100" value="80">
</label>

<p>
 Original: <b><span id="origSize">--</span></b> |
 Expected: <b><span id="estSize">--</span></b>
</p>

<div class="box">
  <a id="download">Download</a>
  <canvas id="canvas" width="500" height="350"></canvas>
</div>

<p><small>Drag to select crop area</small></p>

<button onclick="process()">Process</button>

<script>
let img, fileSize;
let sx=0, sy=0, sw=0, sh=0;
let startX, startY, dragging=false;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

upload.onchange = () => {
  const file = upload.files[0];
  fileSize = file.size;
  origSize.textContent = Math.round(fileSize/1024)+" KB";

  img = new Image();
  img.onload = drawFit;
  img.src = URL.createObjectURL(file);
};

function drawFit(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const r = Math.min(canvas.width/img.width, canvas.height/img.height);
  sw = img.width*r;
  sh = img.height*r;
  sx = (canvas.width-sw)/2;
  sy = (canvas.height-sh)/2;
  ctx.drawImage(img, sx, sy, sw, sh);
  estimate();
}

quality.oninput = () => { qval.textContent=quality.value; estimate(); };
width.oninput = estimate;

function estimate(){
  if(!img) return;
  const q = quality.value/100;
  const scale = width.value/img.width;
  const est = fileSize*q*scale*scale;
  estSize.textContent = Math.max(1,Math.round(est/1024))+" KB";
}

/* ---- Crop selector ---- */
canvas.onmousedown = e => {
  startX = e.offsetX;
  startY = e.offsetY;
  dragging = true;
};

canvas.onmousemove = e => {
  if(!dragging) return;
  drawFit();
  ctx.strokeStyle="red";
  ctx.strokeRect(startX,startY,e.offsetX-startX,e.offsetY-startY);
};

canvas.onmouseup = e => {
  dragging=false;
  sx = startX; sy = startY;
  sw = e.offsetX-startX; sh = e.offsetY-startY;
};
/* ----------------------- */

function process(){
  if(!img || sw<=0 || sh<=0) return alert("Select crop area");

  const ratio = sh/sw;
  const newW = width.value;
  const newH = Math.round(newW*ratio);

  const out = document.createElement("canvas");
  out.width=newW; out.height=newH;
  out.getContext("2d").drawImage(canvas,sx,sy,sw,sh,0,0,newW,newH);

  const data = out.toDataURL("image/jpeg",quality.value/100);
  download.href=data;
  download.download="compressed.jpg";
  download.style.display="block";
}
</script>

</body>
</html>
