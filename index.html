<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Image Compressor with Crop</title>
<style>
 body { font-family: Arial; max-width:600px; margin:40px auto; }
 canvas { border:1px solid #444; cursor:crosshair; }
 label { display:block; margin-top:15px; }
</style>
</head>
<body>

<h3>Image Resizer & Compressor</h3>

<input type="file" id="upload" accept="image/*">

<label>
 Width (px):
 <input type="number" id="width" value="800">
</label>

<label>
 Compression: <span id="qval">80</span>%
 <input type="range" id="quality" min="10" max="100" value="80">
</label>

<p>
 Original size: <b><span id="origSize">--</span></b><br>
 Expected size: <b><span id="estSize">--</span></b>
</p>

<p><b>Drag on image to select crop area</b></p>

<canvas id="canvas"></canvas><br><br>

<button onclick="process()">Process</button>
<a id="download" style="display:none;">Download</a>

<script>
let img, fileSize;
let startX, startY, endX, endY, cropping=false;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

upload.onchange = () => {
  const file = upload.files[0];
  fileSize = file.size;
  origSize.textContent = Math.round(fileSize/1024)+" KB";

  img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
    estimate();
  };
  img.src = URL.createObjectURL(file);
};

quality.oninput = () => {
  qval.textContent = quality.value;
  estimate();
};

width.oninput = estimate;

function estimate(){
  if(!img) return;
  const q = quality.value/100;
  const scale = width.value/img.width;
  const est = fileSize*q*scale*scale;
  estSize.textContent = Math.max(1,Math.round(est/1024))+" KB";
}

/* -------- Crop selection -------- */
canvas.onmousedown = e => {
  startX = e.offsetX;
  startY = e.offsetY;
  cropping = true;
};

canvas.onmousemove = e => {
  if(!cropping) return;
  endX = e.offsetX;
  endY = e.offsetY;
  ctx.drawImage(img,0,0);
  ctx.strokeStyle="red";
  ctx.strokeRect(startX,startY,endX-startX,endY-startY);
};

canvas.onmouseup = () => cropping=false;
/* -------------------------------- */

function process(){
  if(!img) return;

  const sx = Math.min(startX,endX);
  const sy = Math.min(startY,endY);
  const sw = Math.abs(endX-startX);
  const sh = Math.abs(endY-startY);

  const ratio = sh/sw;
  const newW = width.value;
  const newH = Math.round(newW*ratio);

  const out = document.createElement("canvas");
  out.width=newW;
  out.height=newH;

  out.getContext("2d").drawImage(
    img, sx, sy, sw, sh, 0,0,newW,newH
  );

  const data = out.toDataURL("image/jpeg",quality.value/100);
  download.href=data;
  download.download="compressed.jpg";
  download.style.display="inline-block";
  download.textContent="Download Image";
}
</script>

</body>
</html>
