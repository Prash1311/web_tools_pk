<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certificate Generator (Bulk ZIP)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/* ---------- Global ---------- */
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}

/* ---------- Navigation ---------- */
.nav {
  background:#222;
  padding:12px 0;
  display:flex;
  justify-content:center;
  gap:24px;
}

.nav a {
  color:#fff;
  text-decoration:none;
  font-weight:bold;
}

.nav a:hover {
  text-decoration:underline;
}

/* ---------- Coffee Button ---------- */
.donate-float {
  position:fixed;
  top:10px;
  right:10px;
  z-index:3000;
}

.donate-float button {
  background:#ff813f;
  color:#fff;
  border:none;
  border-radius:50%;
  width:44px;
  height:44px;
  font-size:20px;
  cursor:pointer;
}

.qr-box {
  display:none;
  position:absolute;
  top:50px;
  right:0;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}

.qr-box img {
  width:160px;
}

.note {
  font-size:11px;
  text-align:center;
  margin-top:5px;
  color:#555;
}

/* ---------- Page ---------- */
.container {
  max-width:900px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
}

.actions {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:15px;
}

button.action {
  padding:10px 14px;
  border:none;
  border-radius:6px;
  background:#6f42c1;
  color:#fff;
  cursor:pointer;
}

.preview {
  border:1px solid #ccc;
  padding:20px;
  margin-top:20px;
  display:none;
}

.preview .row {
  margin-top:8px;
}
</style>
</head>

<body>

<!-- ‚òï Buy Me a Coffee -->
<div class="donate-float">
  <button onclick="toggleQR()">‚òï</button>
  <div class="qr-box" id="qr">
    <img src="qr.jpg" alt="Donate QR">
    <div class="note">Voluntary support ‚ù§Ô∏è</div>
  </div>
</div>

<!-- Navigation (NO self link) -->
<nav class="nav">
  <a href="index.html">üè† Home</a>
  <a href="image-resizer.html">üñº Image Resizer</a>
  <a href="pdf-resizer.html">üìÑ PDF Resizer</a>
</nav>

<div class="container">
  <h2>Certificate Generator (Excel Upload ‚Üí ZIP)</h2>

  <input type="file" id="file" accept=".xlsx,.csv">

  <div class="actions">
    <button class="action" onclick="loadFile()">Load & Preview First</button>
    <button class="action" onclick="generateZIP()">Generate ALL Certificates (ZIP)</button>
    <button class="action" onclick="downloadTemplate()">‚¨á Download Excel Template</button>
  </div>

  <div class="preview" id="preview">
    <h3>Preview (First Record)</h3>
    <div class="row"><b>Hindi Name:</b> <span id="p_name_hi"></span></div>
    <div class="row"><b>English Name:</b> <span id="p_name_en"></span></div>
    <div class="row"><b>Designation:</b> <span id="p_desig"></span></div>
    <div class="row"><b>School:</b> <span id="p_school"></span></div>
    <div class="row"><b>Region:</b> <span id="p_region"></span></div>
    <div class="row"><b>Training:</b> <span id="p_training"></span></div>
    <div class="row">
      <b>Duration:</b>
      <span id="p_start"></span> to <span id="p_end"></span>
      (<span id="p_hours"></span> hours)
    </div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
let records = [];

/* ---------- Coffee ---------- */
function toggleQR(){
  const q = document.getElementById("qr");
  q.style.display = (q.style.display === "block") ? "none" : "block";
}

/* ---------- Load & Preview ---------- */
function loadFile(){
  const file = document.getElementById("file").files[0];
  if(!file) return alert("Upload Excel / CSV");

  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    records = XLSX.utils.sheet_to_json(sheet);

    if(records.length === 0) return alert("File is empty");
    showPreview(records[0]);
  };
  reader.readAsArrayBuffer(file);
}

function showPreview(r){
  const nameEN = r.name_en;
  const nameHI = r.name_hi && r.name_hi.trim() !== "" ? r.name_hi : r.name_en;

  p_name_hi.textContent = nameHI;
  p_name_en.textContent = nameEN;
  p_desig.textContent = r.designation;
  p_school.textContent = r.school;
  p_region.textContent = r.region;
  p_training.textContent = r.training;
  p_start.textContent = r.start_date;
  p_end.textContent = r.end_date;
  p_hours.textContent = r.hours;

  preview.style.display = "block";
}

/* ---------- Template Download ---------- */
function downloadTemplate(){
  const header = [
    "name_en","name_hi","training","start_date","end_date",
    "hours","designation","school","region"
  ];

  const sample = [
    " Name in English ",
    "Name in hindi",
    "IN-HOUSE TRAINING",
    "start date",
    "End date",
    "Number of hours",
    "Post",
    "School name",
    "PATNA"
  ];

  const csv = header.join(",") + "\n" + sample.join(",");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "certificate_template.csv";
  link.click();
}

/* ---------- PDF Creation ---------- */
function createPDF(r){
  const nameEN = r.name_en;
  const nameHI = r.name_hi && r.name_hi.trim() !== "" ? r.name_hi : r.name_en;

  const pdf = new jsPDF("landscape");

  pdf.setFont("Times","Bold");
  pdf.setFontSize(22);
  pdf.text("KENDRIYA VIDYALAYA SANGATHAN, NEW DELHI",148,25,{align:"center"});

  pdf.setFontSize(18);
  pdf.text("‡§™‡•ç‡§∞‡§Æ‡§æ‡§£-‡§™‡§§‡•ç‡§∞ / Certificate",148,40,{align:"center"});

  pdf.setFont("Times","Normal");
  pdf.setFontSize(14);

  pdf.text(`‡§Ø‡§π ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§∂‡•ç‡§∞‡•Ä/‡§∂‡•ç‡§∞‡•Ä‡§Æ‡§§‡•Ä/‡§∏‡•Å‡§∂‡•ç‡§∞‡•Ä/‡§°‡•â. ${nameHI}`,20,65);
  pdf.text(`‡§™‡§¶‡§®‡§æ‡§Æ : ${r.designation}`,20,75);
  pdf.text(`‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§≤‡§Ø : ${r.school}`,20,85);
  pdf.text(`‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•Ä‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø : ${r.region}`,20,95);

  pdf.text(
    `${r.training} (‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ${r.start_date} ‡§∏‡•á ${r.end_date}) ‡§Æ‡•á‡§Ç ${r.hours} ‡§ò‡§Ç‡§ü‡•á ‡§π‡•á‡§§‡•Å`,
    20,110
  );

  pdf.text("‡§™‡•ç‡§∞‡§§‡§ø‡§≠‡§æ‡§ó‡•Ä / ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§ï ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡§≠‡§æ‡§ó‡§ø‡§§‡§æ ‡§ï‡•Ä‡•§",20,120);

  pdf.text(`This is to certify that ${nameEN}`,20,145);
  pdf.text(
    `has attended ${r.training} from ${r.start_date} to ${r.end_date} for ${r.hours} hours.`,
    20,165
  );

  pdf.text("Principal",250,190);

  return pdf.output("arraybuffer");
}

/* ---------- Bulk ZIP ---------- */
async function generateZIP(){
  if(records.length === 0) return alert("Load Excel first");

  const zip = new JSZip();

  records.forEach((r, i) => {
    const pdfBytes = createPDF(r);
    const safeName = (r.name_en || "certificate_"+(i+1))
      .replace(/[^a-z0-9]/gi,"_");
    zip.file(`${safeName}.pdf`, pdfBytes);
  });

  const blob = await zip.generateAsync({type:"blob"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "certificates.zip";
  link.click();
}
</script>

</body>
</html>
