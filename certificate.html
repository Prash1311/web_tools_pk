<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certificate Generator (Excel ‚Üí ZIP)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Hindi Font -->
<script src="devanagari-font.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}

.nav {
  background:#222;
  padding:12px 0;
  display:flex;
  justify-content:center;
  gap:24px;
}

.nav a {
  color:#fff;
  text-decoration:none;
  font-weight:bold;
}

.container {
  max-width:900px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
}

.actions {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:15px;
}

button {
  padding:10px 14px;
  border:none;
  border-radius:6px;
  background:#6f42c1;
  color:#fff;
  cursor:pointer;
}

.preview {
  display:none;
  border:1px solid #ccc;
  padding:20px;
  margin-top:20px;
}
.preview .row { margin-top:8px; }
</style>
</head>

<body>

<nav class="nav">
  <a href="index.html">üè† Home</a>
  <a href="image-resizer.html">üñº Image Resizer</a>
  <a href="pdf-resizer.html">üìÑ PDF Resizer</a>
</nav>

<div class="container">
  <h2>Certificate Generator (Excel ‚Üí ZIP)</h2>

  <input type="file" id="file" accept=".xlsx,.csv">

  <div class="actions">
    <button onclick="loadFile()">Load & Preview</button>
    <button onclick="generateZIP()">Generate ALL Certificates (ZIP)</button>
    <button onclick="downloadTemplate()">‚¨á Download Template</button>
  </div>

  <div class="preview" id="preview">
    <h3>Preview (First Record)</h3>
    <div class="row"><b>Hindi Name:</b> <span id="p_hi"></span></div>
    <div class="row"><b>English Name:</b> <span id="p_en"></span></div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
let records = [];

/* ======================================================
   HINDI NORMALIZATION (APPLY EVERYWHERE)
   ====================================================== */
function normalizeHindi(text) {
  if (!text) return "";
  return text
    .replace(/‡§™‡•ç‡§∞/g, "‡§™\u200D‡§∞")
    .replace(/‡§§‡•ç‡§∞/g, "‡§§\u200D‡§∞")
    .replace(/‡§ú‡•ç‡§û/g, "‡§ú\u200D‡§û")
    .trim();
}

/* ======================================================
   LOAD & PREVIEW
   ====================================================== */
function loadFile(){
  const f = file.files[0];
  if(!f) return alert("Upload Excel / CSV");

  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
    records = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    if(!records.length) return alert("Empty file");
    previewRecord(records[0]);
  };
  r.readAsArrayBuffer(f);
}

function previewRecord(r){
  const hi = normalizeHindi(
    r.name_hi && r.name_hi.trim() ? r.name_hi : r.name_en
  );

  p_hi.textContent = hi;
  p_en.textContent = r.name_en;
  preview.style.display = "block";
}

/* ======================================================
   TEMPLATE DOWNLOAD (HEADERS ONLY)
   ====================================================== */
function downloadTemplate(){
  const header = [
    "name_en","name_hi","training","start_date",
    "end_date","hours","designation","school","region"
  ];
  const blob = new Blob([header.join(",")], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "certificate_template.csv";
  a.click();
}

/* ======================================================
   PDF CREATION (FULL, CORRECT, KVS STYLE)
   ====================================================== */
function createPDF(r){
  const pdf = new jsPDF("landscape");

  // Register Hindi font
  pdf.addFileToVFS("NotoDeva.ttf", DEVANAGARI_FONT_BASE64);
  pdf.addFont("NotoDeva.ttf", "NotoDeva", "normal");

  const nameHI = normalizeHindi(
    r.name_hi && r.name_hi.trim() ? r.name_hi : r.name_en
  );
  const nameEN = r.name_en;

  /* ---------- Header ---------- */
  pdf.setFont("Times","Bold");
  pdf.setFontSize(22);
  pdf.text(
    "KENDRIYA VIDYALAYA SANGATHAN, NEW DELHI",
    148, 25, {align:"center"}
  );

  pdf.setFont("NotoDeva","normal");
  pdf.setFontSize(18);
  pdf.text(normalizeHindi("‡§™‡•ç‡§∞‡§Æ‡§æ‡§£-‡§™‡§§‡•ç‡§∞"),148,40,{align:"center"});

  /* ---------- Hindi Body (EXACT FLOW) ---------- */
  pdf.setFontSize(14);
  pdf.text(
    normalizeHindi(
      `‡§Ø‡§π ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§∂‡•ç‡§∞‡•Ä/‡§∂‡•ç‡§∞‡•Ä‡§Æ‡§§‡•Ä/‡§∏‡•Å‡§∂‡•ç‡§∞‡•Ä/‡§°‡•â. ${nameHI}`
    ),
    30, 65
  );

  pdf.text(
    normalizeHindi(`${r.start_date} ‡§∏‡•á ${r.end_date} ‡§§‡§ï`),
    30, 85
  );

  pdf.text(
    normalizeHindi(`${r.hours} ‡§ò‡§Ç‡§ü‡•á ‡§π‡•á‡§§‡•Å`),
    30, 105
  );

  /* ---------- English Body ---------- */
  pdf.setFont("Times","Normal");
  pdf.setFontSize(14);

  pdf.text(`This is to certify that ${nameEN}`,30,130);
  pdf.text(
    `has attended training from ${r.start_date} to ${r.end_date}`,
    30,145
