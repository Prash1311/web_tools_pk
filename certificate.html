<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certificate Generator</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
.nav { background:#222; padding:12px; text-align:center; }
.nav a { color:#fff; margin:0 12px; text-decoration:none; font-weight:bold; }

.container {
  max-width:900px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
}

button {
  padding:10px 14px;
  border:none;
  border-radius:6px;
  background:#6f42c1;
  color:#fff;
  cursor:pointer;
  margin-right:10px;
}

.preview {
  display:none;
  border:1px solid #ccc;
  padding:15px;
  margin-top:20px;
}
</style>
</head>

<body>

<nav class="nav">
  <a href="index.html">üè† Home</a>
  <a href="image-resizer.html">üñº Image Resizer</a>
  <a href="pdf-resizer.html">üìÑ PDF Resizer</a>
</nav>

<div class="container">
  <h2>Certificate Generator</h2>

  <input type="file" id="file" accept=".xlsx,.csv"><br><br>

  <button id="btnLoad">Load & Preview</button>
  <button id="btnZip">Generate ZIP</button>
  <button id="btnTemplate">Download Template</button>

  <div class="preview" id="preview">
    <p><b>Hindi Name:</b> <span id="p_hi"></span></p>
    <p><b>English Name:</b> <span id="p_en"></span></p>
  </div>
</div>

<script>
/* ===============================
   SAFE JS ‚Äì NO GLOBAL ONCLICK
   =============================== */

const { jsPDF } = window.jspdf;
let records = [];

document.getElementById("btnLoad").addEventListener("click", loadFile);
document.getElementById("btnZip").addEventListener("click", generateZIP);
document.getElementById("btnTemplate").addEventListener("click", downloadTemplate);

function loadFile(){
  const f = document.getElementById("file").files[0];
  if(!f) return alert("Upload Excel or CSV");

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
    records = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    if(!records.length) return alert("Empty file");

    previewRecord(records[0]);
  };
  reader.readAsArrayBuffer(f);
}

function previewRecord(r){
  document.getElementById("p_hi").textContent =
    r.name_hi && r.name_hi.trim() ? r.name_hi : r.name_en;

  document.getElementById("p_en").textContent = r.name_en;
  document.getElementById("preview").style.display = "block";
}

function downloadTemplate(){
  const headers = [
    "name_en","name_hi","training","start_date",
    "end_date","hours","designation","school","region"
  ];
  const blob = new Blob([headers.join(",")], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "certificate_template.csv";
  a.click();
}

function createPDF(r){
  const pdf = new jsPDF("landscape");

  const hi = r.name_hi && r.name_hi.trim() ? r.name_hi : r.name_en;

  pdf.setFont("Times","Bold");
  pdf.setFontSize(22);
  pdf.text("KENDRIYA VIDYALAYA SANGATHAN, NEW DELHI",148,25,{align:"center"});

  pdf.setFontSize(18);
  pdf.text("‡§™‡•ç‡§∞‡§Æ‡§æ‡§£-‡§™‡§§‡•ç‡§∞",148,40,{align:"center"});

  pdf.setFont("Times","Normal");
  pdf.setFontSize(14);
  pdf.text(`‡§Ø‡§π ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ${hi}`,30,65);
  pdf.text(`${r.start_date} ‡§∏‡•á ${r.end_date} ‡§§‡§ï`,30,85);
  pdf.text(`${r.hours} ‡§ò‡§Ç‡§ü‡•á ‡§π‡•á‡§§‡•Å`,30,105);

  pdf.text(`This is to certify that ${r.name_en}`,30,130);
  pdf.text("Principal",250,190);

  return pdf.output("arraybuffer");
}

async function generateZIP(){
  if(!records.length) return alert("Load file first");

  const zip = new JSZip();
  records.forEach((r,i)=>{
    zip.file(`certificate_${i+1}.pdf`, createPDF(r));
  });

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "certificates.zip";
  a.click();
}
</script>

</body>
</html>
